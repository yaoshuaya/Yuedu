name: "è¶Šç‹±åº”ç”¨æ„å»ºå·¥ä½œæµ"

on:
  schedule:
    - cron: '0 */2 * * *' # æ¯2å°æ—¶è‡ªåŠ¨æ„å»º
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches: [main, master] # ä¸»åˆ†æ”¯æ¨é€æ—¶è§¦å‘

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: macos-latest
    
    # ä¿®å¤ï¼šè®¾ç½®é»˜è®¤shellä¸ºbash
    defaults:
      run:
        shell: bash
        
    # ä¿®å¤ï¼šæ·»åŠ å¿…è¦çš„ç¯å¢ƒå˜é‡
    env:
      GITHUB_WORKSPACE: /Users/runner/work/${{ https://github.com/yaoshuaya/Yuedu }} # æ˜ç¡®è®¾ç½®å·¥ä½œç©ºé—´è·¯å¾„
      HOME: /Users/runner # è®¾ç½®HOMEç›®å½•
      APP_NAME: "Yuedu" # åº”ç”¨åç§°
      IOS_SDK: "iPhoneOS16.5" # iOS SDKç‰ˆæœ¬
      BUILD_SCHEME: "rootless" # æ„å»ºæ–¹æ¡ˆ(rootless/rootful)
      OUTPUT_DIR: "BuildOutput" # æ„å»ºè¾“å‡ºç›®å½•

    steps:
      # æ­¥éª¤1: å½»åº•è§£å†³Gitæƒé™é—®é¢˜
      - name: åˆå§‹åŒ–Gité…ç½®
        run: |
          # è®¾ç½®å…¨å±€Gité…ç½®
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git config --global --add safe.directory '*'
          git config --global protocol.file.allow always
          
          # ä¿®å¤å·¥ä½œç©ºé—´æ‰€æœ‰æƒ
          sudo chown -R runner $GITHUB_WORKSPACE
          sudo chmod -R u+w $GITHUB_WORKSPACE

      # æ­¥éª¤2: å®‰å…¨æ£€å‡ºä»£ç ï¼ˆé¿å…ä½¿ç”¨å­æ¨¡å—ï¼‰
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          path: ${{ env.GITHUB_WORKSPACE }}
          fetch-depth: 0
          # ä¿®å¤ï¼šç¦ç”¨å­æ¨¡å—ä»¥é¿å…æƒé™é—®é¢˜
          submodules: false

      # æ­¥éª¤3: å®‰è£…åŸºç¡€å·¥å…·é“¾
      - name: å®‰è£…Procursuså·¥å…·
        uses: dhinakg/procursus-action@main
        with:
          packages: ldid findutils gsed coreutils make git

      # æ­¥éª¤4: å®‰è£…THEOSæ¡†æ¶ï¼ˆä¸ä½¿ç”¨Gitï¼‰
      - name: å®‰è£…THEOS
        run: |
          set -x
          THEOS_DIR="${{ env.GITHUB_WORKSPACE }}/theos"
          mkdir -p "$THEOS_DIR"
          
          # ä¿®å¤ï¼šç›´æ¥ä¸‹è½½THEOSè€Œä¸æ˜¯ä½¿ç”¨Gitå…‹éš†
          curl -L https://github.com/theos/theos/archive/master.tar.gz | tar -xz -C "$THEOS_DIR" --strip-components=1
          
          echo "THEOS=$THEOS_DIR" >> $GITHUB_ENV
          echo "PATH=$THEOS_DIR/bin:$PATH" >> $GITHUB_ENV

      # æ­¥éª¤5: å®‰è£…iOS SDKï¼ˆé¿å…Gitæ“ä½œï¼‰
      - name: å®‰è£…iOS SDK
        run: |
          set -x
          mkdir -p "$THEOS/sdks"
          
          SDK_URL="https://github.com/theos/sdks/releases/latest/download/${{ env.IOS_SDK }}.sdk.tar.xz"
          
          # å¸¦é‡è¯•çš„ä¸‹è½½
          curl -L --retry 3 --retry-delay 5 $SDK_URL --output "$THEOS/sdks/sdk.tar.xz"
          
          tar -xf "$THEOS/sdks/sdk.tar.xz" -C "$THEOS/sdks"
          rm "$THEOS/sdks/sdk.tar.xz"
          
          # æ ‡å‡†åŒ–SDKç›®å½•å
          if [ ! -d "$THEOS/sdks/${{ env.IOS_SDK }}.sdk" ]; then
            mv "$THEOS/sdks/"*.sdk "$THEOS/sdks/${{ env.IOS_SDK }}.sdk"
          fi

      # æ­¥éª¤6: å®‰è£…æ„å»ºä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          brew update
          brew install libarchive pkg-config

      # æ­¥éª¤7: è®¾ç½®æ„å»ºä¿¡æ¯ï¼ˆé¿å…ä½¿ç”¨Gitå‘½ä»¤ï¼‰
      - name: é…ç½®æ„å»ºä¿¡æ¯
        run: |
          BUILD_TIME=$(date -u +'%Y%m%d_%H%M%S')
          
          # ä»æ–‡ä»¶ä¸­è·å–ç‰ˆæœ¬å·ï¼Œé¿å…ä½¿ç”¨Gitå‘½ä»¤
          if [ -f "VERSION" ]; then
            APP_VERSION=$(cat VERSION)
          elif [ -f "Makefile" ] && grep -q "PACKAGE_VERSION" Makefile; then
            APP_VERSION=$(make print-PACKAGE_VERSION)
          else
            APP_VERSION="1.0.0-$BUILD_TIME" # ç”ŸæˆåŸºäºæ—¶é—´çš„ç‰ˆæœ¬å·
          fi
          
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV
          echo "OUTPUT_PATH=${{ env.OUTPUT_DIR }}/${{ env.APP_NAME }}-v$APP_VERSION.tipa" >> $GITHUB_ENV

      # æ­¥éª¤8: æ‰§è¡Œæ„å»ºï¼ˆé¿å…Gitæ“ä½œï¼‰
      - name: æ„å»ºåº”ç”¨
        run: |
          set -x
          # ç¡®ä¿æƒé™
          sudo chown -R runner .
          
          # æ„å»ºå‘½ä»¤
          make clean || true
          make package \
            THEOS_PACKAGE_SCHEME=${{ env.BUILD_SCHEME }} \
            ARCHS=arm64 \
            TARGET=iphone:clang:latest:13.0 \
            DEBUG=0 \
            FINALPACKAGE=1 \
            -j$(sysctl -n hw.physicalcpu)
          
          # å¤„ç†è¾“å‡ºæ–‡ä»¶
          mkdir -p "${{ env.OUTPUT_DIR }}"
          
          # ä¿®å¤ï¼šä½¿ç”¨findå‘½ä»¤å®šä½tipaæ–‡ä»¶
          TIPA_FILE=$(find . -name "*.tipa" | head -1)
          
          if [ -f "$TIPA_FILE" ]; then
            mv "$TIPA_FILE" "${{ env.OUTPUT_PATH }}"
            echo "æ‰¾åˆ°å¹¶ç§»åŠ¨äº†æ„å»ºäº§ç‰©: $TIPA_FILE"
          else
            echo "##[error]æœªæ‰¾åˆ°ä»»ä½•tipaæ–‡ä»¶!"
            # åˆ—å‡ºå½“å‰ç›®å½•ç»“æ„ä»¥å¸®åŠ©è°ƒè¯•
            ls -laR
            exit 1
          fi

      # æ­¥éª¤9: ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-v${{ env.APP_VERSION }}
          path: ${{ env.OUTPUT_PATH }}

      # æ­¥éª¤10: åˆ›å»ºRelease
      - name: å‘å¸ƒç‰ˆæœ¬
        if: ${{ startsWith(github.ref, 'refs/tags/') }}
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.OUTPUT_PATH }}
          tag_name: ${{ github.ref }}
          name: ${{ env.APP_NAME }} v${{ env.APP_VERSION }}
          body: |
            **æˆåŠŸæ„å»ºç‰ˆæœ¬**  
            ğŸš€ åº”ç”¨: ${{ env.APP_NAME }}  
            ğŸ“¦ ç‰ˆæœ¬: ${{ env.APP_VERSION }}  
            â° æ„å»ºæ—¶é—´: ${{ env.BUILD_TIME }} (UTC)  
            ğŸ”§ æ„å»ºæ–¹æ¡ˆ: ${{ env.BUILD_SCHEME }}  
            [æŸ¥çœ‹å®Œæ•´æ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
